{% extends 'base.html' %}

{% load static %}
{% load custom_filters %}

{% block content %}

<!-- breadcrumb-section -->
<div class="breadcrumb-section breadcrumb-bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 text-center">
                <div class="breadcrumb-text">
                    <p>Fresh and Organic</p>
                    <h1>Cart</h1>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end breadcrumb section -->

<!-- cart -->
<div class="cart-section mt-150 mb-150">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-12">
                <div class="cart-table-wrap">
                    <table class="cart-table">
                        <thead class="cart-table-head">
                            <tr class="table-head-row">
                                <th class="product-remove"></th>
                                <th class="product-image">Product Image</th>
                                <th class="product-name">Name</th>
                                <th class="product-price">Price</th>
                                <th class="product-quantity">Quantity</th>
                                <th class="product-total">Sub Total</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for cart_item in cart_items %}
                            <tr class="table-body-row" data-item-id="{{ cart_item.id }}">
                                <td class="product-remove"><a href="#" class="remove-item"><i class="far fa-window-close"></i></a></td>
                                <td class="product-image"><img src="{{ cart_item.product.image.url }}" alt=""></td>
                                <td class="product-name">{{ cart_item.product.name }}</td>
                                <td class="product-price">${{ cart_item.product.price }}</td>
                                <td class="product-quantity"><input type="number" value="{{ cart_item.quantity }}" min="1" data-item-id="{{ cart_item.id }}"></td>
                                <td class="product-total">${{ cart_item.product.price|multiply:cart_item.quantity }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="total-section">
                    <table class="total-table">
                        <thead class="total-table-head">
                            <tr class="table-total-row">
                                <th>Total</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="total-data">
                                <td><strong>Subtotal:</strong></td>
                                <td id="overall-total">${{ total }}</td>
                            </tr>
                            <tr class="total-data">
                                <td><strong>Shipping: </strong></td>
                                <td>$45</td>
                            </tr>
                            <tr class="total-data">
                                <td><strong>Total: </strong></td>
                                <td>$545</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="cart-buttons">
                        <a id="update-cart-btn" class="boxed-btn black">Update Cart</a>
                        <a href="checkout.html" class="boxed-btn black">Check Out</a>
                    </div>
                </div>

                <div class="coupon-section">
                    <h3>Apply Coupon</h3>
                    <div class="coupon-form-wrap">
                        <form action="index.html">
                            <p><input type="text" placeholder="Coupon"></p>
                            <p><input type="submit" value="Apply"></p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end cart -->

<!-- logo carousel -->
<div class="logo-carousel-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="logo-carousel-inner">
                    <div class="single-logo-item">
                        <img src="{% static 'img/company-logos/1.png' %}" alt="">
                    </div>
                    <div class="single-logo-item">
                        <img src="{% static 'img/company-logos/2.png' %}" alt="">
                    </div>
                    <div class="single-logo-item">
                        <img src="{% static 'img/company-logos/3.png' %}" alt="">
                    </div>
                    <div class="single-logo-item">
                        <img src="{% static 'img/company-logos/4.png' %}" alt="">
                    </div>
                    <div class="single-logo-item">
                        <img src="{% static 'img/company-logos/5.png' %}" alt="">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end logo carousel -->

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Object to store the updated quantities
    let updatedQuantities = {};

    // Function to update the total price for a given row
    function updateRowTotal(row) {
        const priceElement = row.querySelector('.product-price');
        const quantityInput = row.querySelector('.product-quantity input');
        const totalElement = row.querySelector('.product-total');

        const price = parseFloat(priceElement.textContent.replace('$', ''));
        const quantity = parseInt(quantityInput.value);
        const total = price * quantity;

        totalElement.textContent = `$${total.toFixed(2)}`;
    }

    // Function to update the overall total price and quantity
    function updateOverallTotal() {
        let overallTotal = 0;

        document.querySelectorAll('.table-body-row').forEach(row => {
            const totalElement = row.querySelector('.product-total');
            const quantityInput = row.querySelector('.product-quantity input');

            const total = parseFloat(totalElement.textContent.replace('$', ''));
            overallTotal += total;
        });

        document.getElementById('overall-total').textContent = `$${overallTotal.toFixed(2)}`;
    }

    // Add event listeners to quantity inputs
    document.querySelectorAll('.product-quantity input').forEach(input => {
        input.addEventListener('change', function () {
            const row = this.closest('.table-body-row');
            const itemId = this.getAttribute('data-item-id');
            const quantity = this.value;

            // Store the updated quantity
            updatedQuantities[itemId] = quantity;

            updateRowTotal(row);
            updateOverallTotal();
        });
    });

    // Function to send AJAX request to update cart item quantities
    function updateCartItemsQuantities() {
        const formData = new URLSearchParams();
        for (const [itemId, quantity] of Object.entries(updatedQuantities)) {
            formData.append('item_ids[]', itemId);
            formData.append('quantities[]', quantity);
        }

        fetch("{% url 'update_cart_item_quantity' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Cart updated successfully');
                updatedQuantities = {}; // Clear the updated quantities after successful update
            } else {
                console.error('Failed to update cart:', data.message);
            }
        });
    }

    // Function to send AJAX request to remove cart item
    function removeCartItem(itemId, row) {
        fetch("{% url 'remove_cart_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'item_id': itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Item removed successfully');
                row.remove(); // Remove the row from the DOM
                updateOverallTotal(); // Update the overall total
            } else {
                console.error('Failed to remove item:', data.message);
            }
        });
    }

    // Add event listener to the remove item buttons
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            const row = this.closest('.table-body-row');
            const itemId = row.getAttribute('data-item-id');
            removeCartItem(itemId, row);
        });
    });

    // Add event listener to the update cart button
    document.getElementById('update-cart-btn').addEventListener('click', function () {
        updateCartItemsQuantities();
    });

    // Initialize the overall total and quantity
    updateOverallTotal();
});
</script>
{% endblock %}
